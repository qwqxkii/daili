## Xboard Docker-Compose 部署迁移教程
本文教你如何在命令行使用docker-compose + MySQL5.7+内置redis来快速部署Xboard  
需要自行处理好Mysql的安装。
源地址：
```
https://github.com/cedar2025/Xboard/blob/dev/docs/docker-compose%E5%AE%89%E8%A3%85%E6%8C%87%E5%8D%97.md
```
### 部署 (使用docker-compose 2分钟部署)
> 在此提供Xboard安装、快速体验Xboard的步骤。   
使用docker compose + sqlite 快速部署站点（**安装Mysql使用内部redis**）
1. AB安装docker
````
curl -sSL https://get.docker.com | bash
systemctl enable docker
systemctl start docker
````


B机器安装数据库
````
docker pull mysql:5.7
docker volume create mysql
````
将备份包上传到服务器开始执行
将数据倾倒数据库
````
tar xvf qwq_2024-10-28_06.tar.gz -C /var/lib/docker/volumes/mysql/
````
采用容器host模式启动数据库 (下面命令看不明白让AI给你解释)
```
docker run --name mysql --net=host -v mysql:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=这里是密码 -d mysql:5.7 --character-set-server=utf8mb4 --collation-server=utf8mb4_bin
```
或者执行对应脚本
````
cd /var/lib/docker/volumes/mysql/ && cat start.sh
````


#### A机器操作获取Docker compose 文件

请使用自己的备份包，Xboard20240929.tar上传到root下解压

执行info脚本或者手动执行下面命令
````
sudo chown -R 1000:1000 ./.docker/.data/redis
````
修改.env变量，将老的数据库地址修改为新的ip
````
vim ~/Xboard/.env
````

启动Xboard
```
cd /root/Xboard && docker compose up -d
```
> 安装完成之后即可访问你的站点
访问站点 
> 启动之后网站端口默认为7001, 你可以配置nginx反向代理使用80端口  

网站地址:   http://你的IP:7001/   
在此你已经成功部署了, 你可以访问网址体验Xboard的完整功能， 
### 配置端口转发

> （本教程之前已经配置，直接更新域名解析A记录即可）

利用Cloudflare的Origin Rules实现自定域回源指定端口

https://hyrikuma-akari.top/2024/04/07/cf-origin-rules/

### **更新**
1. 修改版本
```
cd Xboard
vi docker-compose.yaml
```
> 修改docker-compose.yaml 当中image后面的版本号为你需要的版本  
> 如果为版本为latest 则可以忽略这一步，直接进行第二步

2. 更新数据库（可以执行多次都是安全的）
```
docker compose pull
docker compose down
docker compose run -it --rm xboard php artisan xboard:update
docker compose up -d
```
> 即可更新成功

### **回滚**
> 此回滚不回滚数据库，是否回滚数据库请查看相关文档
1. 回退版本  
```
vi docker-compose.yaml
```
> 修改docker-compose.yaml 当中image后面的版本号为更新前的版本号
2. 启动
```
docker compose up -d
```

### 注意
启用webman后做的任何代码修改都需要重启生效